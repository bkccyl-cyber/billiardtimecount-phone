<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>撞球專業賽事系統 - 裁判控制版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --bg: #000; --green: #00ff00; --red: #ff3b30; --blue: #007aff; --btn: #2a2a2a; --yellow: #ffcc00; --orange: #ff9500; --purple: #af52de; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 頂部資訊 */
        .peer-info { height: 40px; background: #1a1a1a; padding: 0 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid #333; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; background: #555; }
        .online { background: var(--green); box-shadow: 0 0 8px var(--green); }

        /* 比分區 */
        .score-row { display: flex; height: 20%; border-bottom: 1px solid #333; flex-shrink: 0; }
        .team { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .team-a { background: var(--red); }
        .team-b { background: var(--blue); }
        .team-name { font-size: 1rem; font-weight: bold; opacity: 0.9; }
        .score-val { font-size: 8vh; font-weight: bold; line-height: 1; }
        
        /* 扣分小叉叉 */
        .minus-btn { position: absolute; top: 5px; right: 5px; width: 35px; height: 35px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 10; }
        .minus-btn:active { background: #000; }

        .tag-container { position: absolute; bottom: 4px; display: flex; gap: 3px; }
        .ext-tag, .to-tag { padding: 1px 6px; font-weight: bold; border-radius: 3px; display: none; font-size: 0.7rem; }
        .ext-tag { background: var(--yellow); color: #000; }
        .to-tag { background: var(--purple); color: #fff; }

        /* 讀秒顯示區 */
        .timer-zone { height: 20%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: #080808; }
        #timer-display { font-size: 15vh; font-weight: bold; color: var(--green); line-height: 1; }
        .race-to-display { font-size: 0.8rem; color: var(--yellow); font-weight: bold; }
        .status-text { font-size: 12px; color: #666; position: absolute; top: 5px; }
        .warning { color: var(--red) !important; }

        /* 控制按鈕區 (裁判專用大按鈕) */
        .controls { flex-grow: 1; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); gap: 6px; padding: 8px; background: #000; }
        .btn { border: none; border-radius: 12px; color: #fff; background: var(--btn); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        
        /* Start 30s 特大綠色 */
        .btn-main { grid-column: span 2; background: #1a5c1a; border: 2px solid var(--green); }
        .btn-main .btn-k { font-size: 2rem; font-weight: 900; }
        
        /* 功能按鈕文字 */
        .btn-k { font-size: 1.2rem; font-weight: bold; }
        .btn-sub { font-size: 0.8rem; opacity: 0.7; }

        /* QR & 勝負樣式 */
        #qr-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode { background: white; padding: 10px; border-radius: 10px; }
        .victory-a { background: var(--red) !important; }
        .victory-b { background: var(--blue) !important; }
        .winner-text { font-size: 12vh !important; color: white !important; }
        .hidden-mode .controls { display: none; }
        .hidden-mode .score-row { height: 45%; }
        .hidden-mode #timer-display { font-size: 40vh; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="peer-info">
        <div><span id="conn-dot" class="status-dot"></span> <span id="my-id-display">...</span></div>
        <div style="display:flex; gap:5px;">
            <button onclick="showQRCode()" style="padding:4px 8px; background:var(--green); border:none; border-radius:4px; font-size:11px; color:black; font-weight:bold;">掃碼連線</button>
            <button onclick="toggleDisplayMode()" id="mode-btn" style="padding:4px 8px; background:var(--yellow); border:none; border-radius:4px; font-size:11px; color:black; font-weight:bold;">切換顯示</button>
            <button onclick="setupTimes()" style="padding:4px 8px; background:#444; border:none; border-radius:4px; font-size:11px; color:white;">⚙️</button>
        </div>
    </div>

    <div class="score-row">
        <div class="team team-a" onclick="handleInput('scoreA+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreA-')">×</div>
            <div class="team-name" id="nameA">PLAYER A</div>
            <div class="score-val" id="scoreA">0</div>
            <div class="tag-container"><div id="extA" class="ext-tag">EXT</div><div id="toA" class="to-tag">T.O.</div></div>
        </div>
        <div class="team team-b" onclick="handleInput('scoreB+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreB-')">×</div>
            <div class="team-name" id="nameB">PLAYER B</div>
            <div class="score-val" id="scoreB">0</div>
            <div class="tag-container"><div id="extB" class="ext-tag">EXT</div><div id="toB" class="to-tag">T.O.</div></div>
        </div>
    </div>

    <div class="timer-zone">
        <div class="status-text" id="status-text">WAITING</div>
        <div class="race-to-display" id="race-to-text">RACE TO --</div>
        <div id="timer-display">00</div>
    </div>

    <div class="controls">
        <button class="btn btn-main" onclick="handleInput('start_30')">
            <div class="btn-k">START (30s)</div>
            <div class="btn-sub">或按音量鍵 [+]</div>
        </button>
        <button class="btn" onclick="handleInput('start_60')">
            <div class="btn-k">Open Time</div><div class="btn-sub">60s</div>
        </button>
        <button class="btn" style="border:1.5px solid var(--yellow);" onclick="handleInput('pause')">
            <div class="btn-k">Pause</div><div class="btn-sub">暫停 [音量-]</div>
        </button>
        <button class="btn" style="border:1px solid var(--purple);" onclick="handleInput('toA')">
            <div class="btn-k">T.O. A</div>
        </button>
        <button class="btn" style="border:1px solid var(--purple);" onclick="handleInput('toB')">
            <div class="btn-k">T.O. B</div>
        </button>
        <button class="btn" onclick="handleInput('extA')">
            <div class="btn-k">A 延長</div>
        </button>
        <button class="btn" onclick="handleInput('extB')">
            <div class="btn-k">B 延長</div>
        </button>
        <button class="btn" style="grid-column: span 2; background:#331111;" onclick="if(confirm('重設所有分數與時間？')) handleInput('resetAll')">
            <div class="btn-k" style="font-size: 1rem; color:var(--red);">Reset All (歸零)</div>
        </button>
    </div>

    <div id="qr-overlay" onclick="this.style.display='none'">
        <div id="qrcode"></div>
        <p style="margin-top:15px; font-size:14px;">讓另一支手機掃描以同步控制</p>
    </div>

    <script>
        let p = null, client = null, audioCtx = null;
        let myId = 'B-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        let timeLeft = 0, timerId = null, scores = { A: 0, B: 0 }, config = { key0: 30, key2: 60, raceTo: 0 };
        let isPaused = false, isTimeoutMode = false, lastNormalTime = 0, isGameOver = false;

        // 音量鍵監聽
        window.addEventListener('keydown', function(e) {
            if (e.key === "VolumeUp" || e.key === "AudioVolumeUp") {
                e.preventDefault();
                handleInput('start_30');
            } else if (e.key === "VolumeDown" || e.key === "AudioVolumeDown") {
                e.preventDefault();
                handleInput('pause');
            }
        }, { passive: false });

        function initSignaling() {
            document.getElementById('my-id-display').innerText = "ID: " + myId;
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', () => {
                client.subscribe(`match/signal/${myId}`);
                document.getElementById('conn-dot').className = "status-dot";
                checkUrlParams();
            });
            client.on('message', (topic, msg) => {
                const data = JSON.parse(msg.toString());
                if (data.to === myId) {
                    if (!p) initP2P(false, data.from);
                    p.signal(data.signal);
                }
            });
        }

        function initP2P(initiator, receiverId) {
            p = new SimplePeer({ initiator, trickle: true, config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
            p.on('signal', data => client.publish(`match/signal/${receiverId}`, JSON.stringify({ from: myId, to: receiverId, signal: data })));
            p.on('connect', () => document.getElementById('conn-dot').className = "status-dot online");
            p.on('data', data => processCommand(data.toString()));
            p.on('close', () => { document.getElementById('conn-dot').className = "status-dot"; p = null; });
        }

        function checkUrlParams() {
            const joinId = new URLSearchParams(window.location.search).get('join');
            if (joinId) initP2P(true, joinId);
        }

        function showQRCode() {
            const overlay = document.getElementById('qr-overlay');
            const qrBox = document.getElementById('qrcode');
            qrBox.innerHTML = ""; overlay.style.display = 'flex';
            new QRCode(qrBox, { text: `${window.location.origin}${window.location.pathname}?join=${myId}`, width: 200, height: 200 });
        }

        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const b = audioCtx.createBuffer(1, 1, 22050), s = audioCtx.createBufferSource();
                s.buffer = b; s.connect(audioCtx.destination); s.start();
            }
        }

        function playBeep(f, d) {
            if (!audioCtx) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
        }

        function handleInput(cmd) {
            unlockAudio();
            if (p && p.connected) p.send(cmd);
            processCommand(cmd);
        }

        function processCommand(cmd) {
            if (isGameOver && cmd !== 'resetAll') return;
            if (cmd === 'start_30') { stopTimeout(); startTimer(config.key0); }
            else if (cmd === 'start_60') { stopTimeout(); startTimer(config.key2); }
            else if (cmd === 'pause') togglePause();
            else if (cmd === 'resetAll') resetEverything();
            else if (cmd === 'scoreA+') { updateScore('A', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreB+') { updateScore('B', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreA-') updateScore('A', -1);
            else if (cmd === 'scoreB-') updateScore('B', -1);
            else if (cmd === 'extA') { showExt('A'); addTime(config.key0); }
            else if (cmd === 'extB') { showExt('B'); addTime(config.key0); }
            else if (cmd === 'toA') toggleTimeout('A');
            else if (cmd === 'toB') toggleTimeout('B');
            else if (cmd.startsWith('config:')) { config = JSON.parse(cmd.split('config:')[1]); updateRaceToUI(); }
        }

        function startTimer(sec) {
            if (timerId) clearInterval(timerId);
            timeLeft = Number(sec); isPaused = false; updateDisplay();
            document.getElementById('status-text').innerText = isTimeoutMode ? "TIME OUT" : "COUNTING";
            timerId = setInterval(() => {
                if (!isPaused) {
                    timeLeft--; updateDisplay();
                    if (timeLeft === 10) playBeep(880, 0.1);
                    else if (timeLeft <= 5 && timeLeft > 0) playBeep(1200, 0.1);
                    if (timeLeft <= 0) { clearInterval(timerId); timerId = null; playBeep(440, 0.8); document.getElementById('status-text').innerText = "TIME UP"; }
                }
            }, 1000);
        }

        function updateDisplay() {
            const d = document.getElementById('timer-display');
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            d.innerText = isTimeoutMode ? `${m}:${s < 10 ? '0'+s : s}` : (timeLeft < 10 ? "0"+timeLeft : timeLeft);
            d.className = (timeLeft <= 5 && timeLeft > 0 && !isPaused ? "warning" : "");
        }

        function updateScore(t, v) { scores[t] = Math.max(0, scores[t] + v); document.getElementById(`score${t}`).innerText = scores[t]; }
        function showExt(t) { document.getElementById('ext'+t).style.display='block'; }
        function clearExt() { document.getElementById('extA').style.display='none'; document.getElementById('extB').style.display='none'; }
        function addTime(s) { timeLeft += s; updateDisplay(); if (!timerId) startTimer(timeLeft); }
        function togglePause() { if (timerId || timeLeft > 0) { isPaused = !isPaused; document.getElementById('status-text').innerText = isPaused ? "PAUSED" : "COUNTING"; } }
        
        function toggleTimeout(t) { 
            if (isTimeoutMode) { stopTimeout(); return; }
            lastNormalTime = timeLeft; isTimeoutMode = true;
            document.getElementById('to'+t).style.display = 'block';
            startTimer(300);
        }
        function stopTimeout() { if (!isTimeoutMode) return; isTimeoutMode = false; startTimer(lastNormalTime); }

        function checkWinner() {
            if (config.raceTo > 0) {
                if (scores.A >= config.raceTo) showVictory('A');
                else if (scores.B >= config.raceTo) showVictory('B');
            }
        }
        function showVictory(winner) {
            isGameOver = true; if (timerId) clearInterval(timerId);
            document.body.className = winner === 'A' ? 'victory-a' : 'victory-b';
            document.getElementById('timer-display').innerText = "WINNER";
            document.getElementById('timer-display').classList.add('winner-text');
        }

        function resetEverything() {
            if (timerId) clearInterval(timerId);
            timerId = null; scores = {A:0, B:0}; isGameOver = false; isTimeoutMode = false; timeLeft = 0;
            updateScore('A', 0); updateScore('B', 0);
            document.getElementById('toA').style.display='none'; document.getElementById('toB').style.display='none';
            clearExt(); document.body.className = ""; updateDisplay(); updateRaceToUI();
            document.getElementById('status-text').innerText = "READY";
        }

        function updateRaceToUI() { document.getElementById('race-to-text').innerText = config.raceTo > 0 ? `RACE TO ${config.raceTo}` : "RACE TO --"; }
        function setupTimes() {
            config.key0 = Number(prompt("Start 秒數：", config.key0)) || 30;
            config.raceTo = Number(prompt("搶幾局 (Race To)：", config.raceTo)) || 0;
            handleInput("config:" + JSON.stringify(config));
        }
        function toggleDisplayMode() { document.body.classList.toggle('hidden-mode'); }

        window.onload = initSignaling;
    </script>
</body>
</html>