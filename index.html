<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>撞球賽事系統 - SimplePeer 強化版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --bg: #000; --green: #00ff00; --red: #ff3b30; --blue: #007aff; --btn: #2a2a2a; --yellow: #ffcc00; --purple: #af52de; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 狀態列 */
        .peer-info { height: 45px; background: #1a1a1a; padding: 0 12px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #555; }
        .signaling { background: var(--yellow); box-shadow: 0 0 10px var(--yellow); }
        .online { background: var(--green); box-shadow: 0 0 10px var(--green); }

        /* 比分區 */
        .score-row { display: flex; height: 22%; border-bottom: 1px solid #333; }
        .team { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .team-a { background: var(--red); }
        .team-b { background: var(--blue); }
        .score-val { font-size: 10vh; font-weight: bold; line-height: 1; }
        .minus-btn { position: absolute; top: 8px; right: 8px; width: 40px; height: 40px; background: rgba(0,0,0,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.5); font-size: 24px; }

        /* 讀秒區 (盲操作) */
        .timer-zone { height: 18%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #080808; cursor: pointer; position: relative; }
        #timer-display { font-size: 15vh; font-weight: bold; color: var(--green); }
        .warning { color: var(--red) !important; }
        .status-msg { position: absolute; top: 5px; font-size: 11px; color: #555; }

        /* 控制按鈕 */
        .controls { flex-grow: 1; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); gap: 8px; padding: 10px; }
        .btn { border: none; border-radius: 12px; color: #fff; background: var(--btn); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .btn:active { opacity: 0.6; scale: 0.97; }
        .btn-main { grid-column: span 2; background: #1a5c1a; border: 2.5px solid var(--green); }
        .btn-ext { background: #4d4000; border: 1px solid var(--yellow); }
        .btn-to { background: #2d1a4d; border: 1px solid var(--purple); }
        .btn-k { font-size: 1.3rem; font-weight: bold; }
        .btn-sub { font-size: 0.8rem; opacity: 0.7; }

        .tag { position: absolute; bottom: 5px; font-weight: bold; display: none; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        #qr-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode { background: white; padding: 15px; border-radius: 12px; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="peer-info">
        <div><span id="conn-dot" class="status-dot"></span> <span id="my-id-display">Connecting...</span></div>
        <div style="display:flex; gap:6px;">
            <button onclick="showQRCode()" style="padding:6px 12px; background:var(--green); border:none; border-radius:5px; font-weight:bold; color:#000;">掃碼連線</button>
            <button onclick="if(confirm('重設？')) handleInput('resetAll')" style="padding:6px 12px; background:#444; border:none; border-radius:5px; color:#fff;">Reset</button>
        </div>
    </div>

    <div class="score-row">
        <div class="team team-a" onclick="handleInput('scoreA+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreA-')">×</div>
            <div class="score-val" id="scoreA">0</div>
            <div id="extA" class="tag" style="background:var(--yellow); color:#000; left:8px;">EXT</div>
            <div id="toA" class="tag" style="background:var(--purple); color:#fff; right:8px;">T.O.</div>
        </div>
        <div class="team team-b" onclick="handleInput('scoreB+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreB-')">×</div>
            <div class="score-val" id="scoreB">0</div>
            <div id="extB" class="tag" style="background:var(--yellow); color:#000; left:8px;">EXT</div>
            <div id="toB" class="tag" style="background:var(--purple); color:#fff; right:8px;">T.O.</div>
        </div>
    </div>

    <div class="timer-zone" onclick="handleInput('start_30')">
        <div class="status-msg" id="status-text">點擊此區或音量鍵啟動</div>
        <div id="timer-display">00</div>
    </div>

    <div class="controls">
        <button class="btn btn-main" onclick="handleInput('start_30')">
            <div class="btn-k">START (30s)</div>
            <div class="btn-sub">音量鍵 [+]</div>
        </button>
        
        <button class="btn" onclick="handleInput('start_60')">
            <div class="btn-k">Open (60s)</div>
        </button>
        <button class="btn" style="border:1px solid var(--yellow)" onclick="handleInput('pause')">
            <div class="btn-k">Pause</div>
            <div class="btn-sub">暫停 [音量-]</div>
        </button>
        
        <button class="btn btn-ext" onclick="handleInput('extA')"><div class="btn-k">A 延長</div></button>
        <button class="btn btn-ext" onclick="handleInput('extB')"><div class="btn-k">B 延長</div></button>
        
        <button class="btn btn-to" onclick="handleInput('toA')"><div class="btn-k">T.O. A</div></button>
        <button class="btn btn-to" onclick="handleInput('toB')"><div class="btn-k">T.O. B</div></button>
    </div>

    <div id="qr-overlay" onclick="this.style.display='none'"><div id="qrcode"></div><p style="color:#fff; margin-top:15px;">讓另一台手機掃描進行同步</p></div>

    <script>
        let peer = null, mqttClient = null, audioCtx = null;
        const myId = 'P-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        let timeLeft = 0, timerId = null, scores = {A:0, B:0}, isPaused = false, isTO = false;

        // 監聽音量鍵
        window.addEventListener('keydown', (e) => {
            const up = (e.key === "VolumeUp" || e.keyCode === 175);
            const down = (e.key === "VolumeDown" || e.keyCode === 174);
            if(up) { e.preventDefault(); handleInput('start_30'); }
            if(down) { e.preventDefault(); handleInput('pause'); }
        }, { capture: true, passive: false });

        function initPeer(initiator, targetId) {
            if (peer) peer.destroy();
            peer = new SimplePeer({
                initiator: initiator,
                trickle: false,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }
            });

            peer.on('signal', data => {
                mqttClient.publish(`pool/signal/${targetId}`, JSON.stringify({ from: myId, signal: data }));
            });

            peer.on('connect', () => {
                document.getElementById('conn-dot').className = "status-dot online";
                document.getElementById('qr-overlay').style.display = 'none';
                document.getElementById('status-text').innerText = "連線成功";
            });

            peer.on('data', data => processCommand(data.toString()));
            peer.on('close', () => { document.getElementById('conn-dot').className = "status-dot signaling"; peer = null; });
        }

        function initSignaling() {
            mqttClient = mqtt.connect('wss://broker.hivemq.com:8044/mqtt');
            mqttClient.on('connect', () => {
                document.getElementById('my-id-display').innerText = "ID: " + myId;
                document.getElementById('conn-dot').className = "status-dot signaling";
                mqttClient.subscribe(`pool/signal/${myId}`);
                
                const joinId = new URLSearchParams(window.location.search).get('join');
                if (joinId) initPeer(true, joinId);
            });

            mqttClient.on('message', (topic, msg) => {
                const data = JSON.parse(msg.toString());
                if (!peer) initPeer(false, data.from);
                peer.signal(data.signal);
            });
        }

        function handleInput(cmd) {
            unlockAudio();
            if (peer && peer.connected) peer.send(cmd);
            processCommand(cmd);
        }

        function processCommand(cmd) {
            if (cmd === 'start_30') startTimer(30);
            else if (cmd === 'start_60') startTimer(60);
            else if (cmd === 'pause') { isPaused = !isPaused; document.getElementById('status-text').innerText = isPaused ? "已暫停" : "計時中"; }
            else if (cmd === 'scoreA+') updateScore('A', 1);
            else if (cmd === 'scoreA-') updateScore('A', -1);
            else if (cmd === 'scoreB+') updateScore('B', 1);
            else if (cmd === 'scoreB-') updateScore('B', -1);
            else if (cmd === 'extA') { document.getElementById('extA').style.display='block'; timeLeft += 30; updateDisplay(); }
            else if (cmd === 'extB') { document.getElementById('extB').style.display='block'; timeLeft += 30; updateDisplay(); }
            else if (cmd === 'toA') toggleTO('A');
            else if (cmd === 'toB') toggleTO('B');
            else if (cmd === 'resetAll') location.reload();
        }

        function startTimer(sec) {
            if (timerId) clearInterval(timerId);
            timeLeft = sec; isPaused = false;
            document.getElementById('status-text').innerText = "計時中";
            timerId = setInterval(() => {
                if (!isPaused && timeLeft > 0) {
                    timeLeft--;
                    if (timeLeft === 10) playBeep(880, 0.1);
                    if (timeLeft <= 5) speak(timeLeft);
                    updateDisplay();
                    if (timeLeft === 0) { playBeep(440, 0.7); document.getElementById('status-text').innerText = "TIME UP"; }
                }
            }, 1000);
            updateDisplay();
        }

        function updateDisplay() {
            const d = document.getElementById('timer-display');
            d.innerText = timeLeft < 10 ? "0" + timeLeft : timeLeft;
            d.className = (timeLeft <= 5 && timeLeft > 0) ? "warning" : "";
        }

        function updateScore(t, v) { 
            scores[t] = Math.max(0, scores[t] + v); 
            document.getElementById('score' + t).innerText = scores[t]; 
            document.getElementById('ext'+t).style.display='none'; // 加分時清除延長標記
        }

        function toggleTO(t) {
            isTO = !isTO;
            document.getElementById('to' + t).style.display = isTO ? 'block' : 'none';
            startTimer(isTO ? 300 : 30);
        }

        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const b = audioCtx.createBuffer(1, 1, 22050), s = audioCtx.createBufferSource();
                s.buffer = b; s.connect(audioCtx.destination); s.start();
            }
        }

        function playBeep(f, d) {
            if (!audioCtx) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.frequency.value = f; o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function speak(n) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(n.toString());
            m.lang = 'en-US'; m.rate = 1.6; window.speechSynthesis.speak(m);
        }

        function showQRCode() {
            const q = document.getElementById('qrcode'); q.innerHTML = "";
            new QRCode(q, { text: window.location.origin + window.location.pathname + "?join=" + myId, width: 220, height: 220 });
            document.getElementById('qr-overlay').style.display = 'flex';
        }

        window.onload = initSignaling;
    </script>
</body>
</html>
