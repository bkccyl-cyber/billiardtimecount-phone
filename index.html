<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>撞球賽事系統 - 專業裁判版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --bg: #000; --green: #00ff00; --red: #ff3b30; --blue: #007aff; --btn: #2a2a2a; --yellow: #ffcc00; --orange: #ff9500; --purple: #af52de; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 頂部狀態列 */
        .peer-info { height: 45px; background: #1a1a1a; padding: 0 12px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid #333; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #555; transition: 0.3s; }
        .signaling { background: var(--yellow) !important; box-shadow: 0 0 10px var(--yellow); }
        .online { background: var(--green) !important; box-shadow: 0 0 10px var(--green); }

        /* 比分區域 */
        .score-row { display: flex; height: 22%; border-bottom: 1px solid #333; flex-shrink: 0; }
        .team { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .team-a { background: var(--red); }
        .team-b { background: var(--blue); }
        .team-name { font-size: 1.1rem; font-weight: bold; opacity: 0.9; margin-bottom: 5px; }
        .score-val { font-size: 10vh; font-weight: bold; line-height: 1; }
        
        /* 扣分小叉叉 */
        .minus-btn { position: absolute; top: 8px; right: 8px; width: 40px; height: 40px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 10; }
        .minus-btn:active { background: #000; scale: 0.9; }

        .tag-container { position: absolute; bottom: 6px; display: flex; gap: 4px; }
        .ext-tag, .to-tag { padding: 2px 8px; font-weight: bold; border-radius: 4px; display: none; font-size: 0.8rem; }
        .ext-tag { background: var(--yellow); color: #000; animation: blink 1s infinite alternate; }
        .to-tag { background: var(--purple); color: #fff; }

        /* 讀秒顯示區 (盲操作：點擊此區即 Start 30s) */
        .timer-zone { height: 18%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: #080808; cursor: pointer; }
        .timer-zone:active { background: #222; }
        #timer-display { font-size: 15vh; font-weight: bold; color: var(--green); line-height: 1; transition: color 0.3s; }
        .race-to-display { font-size: 0.9rem; color: var(--yellow); font-weight: bold; }
        .status-text { font-size: 12px; color: #777; position: absolute; top: 6px; }
        .warning { color: var(--red) !important; }

        /* 裁判專用控制鈕 (佈局優化) */
        .controls { flex-grow: 1; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); gap: 8px; padding: 10px; background: #000; }
        .btn { border: none; border-radius: 14px; color: #fff; background: var(--btn); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; }
        .btn:active { opacity: 0.6; transform: scale(0.96); }
        
        .btn-main { grid-column: span 2; background: #1a5c1a; border: 2.5px solid var(--green); }
        .btn-main .btn-k { font-size: 2rem; font-weight: 900; }
        
        .btn-ext { background: #4d4000; border: 1px solid var(--yellow); }
        .btn-to { background: #2d1a4d; border: 1px solid var(--purple); }

        .btn-k { font-size: 1.3rem; font-weight: bold; }
        .btn-sub { font-size: 0.8rem; opacity: 0.7; margin-top: 2px; }

        #qr-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode { background: white; padding: 15px; border-radius: 12px; }
        
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        /* 全螢幕/顯示模式 */
        .hidden-mode .controls { display: none; }
        .hidden-mode .score-row { height: 45%; }
        .hidden-mode #timer-display { font-size: 42vh; }
        .hidden-mode .minus-btn { display: none; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="peer-info">
        <div><span id="conn-dot" class="status-dot"></span> <span id="my-id-display">初始化中...</span></div>
        <div style="display:flex; gap:6px;">
            <button onclick="showQRCode()" style="padding:6px 12px; background:var(--green); border:none; border-radius:5px; font-size:12px; color:black; font-weight:bold;">掃碼連線</button>
            <button onclick="toggleDisplayMode()" id="mode-btn" style="padding:6px 12px; background:var(--yellow); border:none; border-radius:5px; font-size:12px; color:black; font-weight:bold;">切換顯示</button>
            <button onclick="setupTimes()" style="padding:6px 12px; background:#444; border:none; border-radius:5px; font-size:12px; color:white;">⚙️</button>
        </div>
    </div>

    <div class="score-row">
        <div class="team team-a" onclick="handleInput('scoreA+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreA-')">×</div>
            <div class="team-name" id="nameA">PLAYER A</div>
            <div class="score-val" id="scoreA">0</div>
            <div class="tag-container"><div id="extA" class="ext-tag">EXT</div><div id="toA" class="to-tag">T.O.</div></div>
        </div>
        <div class="team team-b" onclick="handleInput('scoreB+')">
            <div class="minus-btn" onclick="event.stopPropagation(); handleInput('scoreB-')">×</div>
            <div class="team-name" id="nameB">PLAYER B</div>
            <div class="score-val" id="scoreB">0</div>
            <div class="tag-container"><div id="extB" class="ext-tag">EXT</div><div id="toB" class="to-tag">T.O.</div></div>
        </div>
    </div>

    <div class="timer-zone" onclick="handleInput('start_30')">
        <div class="status-text" id="status-text">點擊此處解鎖語音</div>
        <div class="race-to-display" id="race-to-text">RACE TO --</div>
        <div id="timer-display">00</div>
    </div>

    <div class="controls">
        <button class="btn btn-main" onclick="handleInput('start_30')">
            <div class="btn-k">START (30s)</div>
            <div class="btn-sub">或音量鍵 [+]</div>
        </button>
        
        <button class="btn" onclick="handleInput('start_60')">
            <div class="btn-k">Open (60s)</div>
        </button>
        <button class="btn" style="border:1.5px solid var(--yellow);" onclick="handleInput('pause')">
            <div class="btn-k">Pause</div><div class="btn-sub">暫停 [音量-]</div>
        </button>

        <button class="btn btn-ext" onclick="handleInput('extA')">
            <div class="btn-k">A 延長</div>
        </button>
        <button class="btn btn-ext" onclick="handleInput('extB')">
            <div class="btn-k">B 延長</div>
        </button>

        <button class="btn btn-to" onclick="handleInput('toA')">
            <div class="btn-k">T.O. A</div>
            <div class="btn-sub">5 min</div>
        </button>
        <button class="btn btn-to" onclick="handleInput('toB')">
            <div class="btn-k">T.O. B</div>
            <div class="btn-sub">5 min</div>
        </button>
    </div>

    <div style="padding: 6px; background:#000; text-align:center;">
        <span onclick="if(confirm('重設所有數據？')) handleInput('resetAll')" style="color:#444; font-size:12px; text-decoration:underline; cursor:pointer;">Reset Everything</span>
    </div>

    <div id="qr-overlay" onclick="this.style.display='none'">
        <div id="qrcode"></div>
        <p style="margin-top:20px; font-size:15px; color:#fff;">請另一台手機掃碼進行連線</p>
    </div>

    <script>
        let p = null, client = null, audioCtx = null;
        let myId = 'B-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        let timeLeft = 0, timerId = null, scores = { A: 0, B: 0 }, config = { key0: 30, key2: 60, raceTo: 0 };
        let isPaused = false, isTimeoutMode = false, lastNormalTime = 0, isGameOver = false;

        // 音量鍵實體控制 (含容錯)
        window.addEventListener('keydown', function(e) {
            const volUp = (e.key === "VolumeUp" || e.key === "AudioVolumeUp" || e.keyCode === 175);
            const volDown = (e.key === "VolumeDown" || e.key === "AudioVolumeDown" || e.keyCode === 174);
            if (volUp) { e.preventDefault(); handleInput('start_30'); }
            else if (volDown) { e.preventDefault(); handleInput('pause'); }
        }, { capture: true, passive: false });

        function initSignaling() {
            document.getElementById('my-id-display').innerText = "ID: " + myId;
            // 改用更穩定的公共 Broker
            client = mqtt.connect('wss://broker.hivemq.com:8044/mqtt');
            
            client.on('connect', () => {
                client.subscribe(`match/signal/${myId}`, (err) => {
                    if (!err) {
                        document.getElementById('conn-dot').className = "status-dot signaling";
                        document.getElementById('status-text').innerText = "連線伺服器就緒";
                        checkUrlParams();
                    }
                });
            });

            client.on('message', (topic, msg) => {
                try {
                    const data = JSON.parse(msg.toString());
                    if (!p) initP2P(false, data.from);
                    p.signal(data.signal);
                } catch(e) {}
            });
        }

        function initP2P(initiator, receiverId) {
            const peerConfig = {
                initiator,
                trickle: true,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            };
            p = new SimplePeer(peerConfig);
            
            p.on('signal', data => {
                client.publish(`match/signal/${receiverId}`, JSON.stringify({ from: myId, to: receiverId, signal: data }));
            });

            p.on('connect', () => {
                document.getElementById('conn-dot').className = "status-dot online";
                document.getElementById('status-text').innerText = "雙機連線成功";
                document.getElementById('qr-overlay').style.display = 'none';
            });

            p.on('data', data => processCommand(data.toString()));
            p.on('close', () => { document.getElementById('conn-dot').className = "status-dot signaling"; p = null; });
            p.on('error', () => { document.getElementById('conn-dot').className = "status-dot signaling"; });
        }

        function checkUrlParams() {
            const joinId = new URLSearchParams(window.location.search).get('join');
            if (joinId) initP2P(true, joinId);
        }

        function showQRCode() {
            const qrBox = document.getElementById('qrcode');
            qrBox.innerHTML = ""; 
            document.getElementById('qr-overlay').style.display = 'flex';
            new QRCode(qrBox, { text: window.location.origin + window.location.pathname + "?join=" + myId, width: 220, height: 220 });
        }

        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const b = audioCtx.createBuffer(1, 1, 22050), s = audioCtx.createBufferSource();
                s.buffer = b; s.connect(audioCtx.destination); s.start();
                document.getElementById('status-text').innerText = "音效系統已就緒";
            }
        }

        function playBeep(f, d) {
            if (!audioCtx) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
        }

        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US'; msg.rate = 1.4;
            window.speechSynthesis.speak(msg);
        }

        function handleInput(cmd) {
            unlockAudio();
            if (p && p.connected) p.send(cmd);
            processCommand(cmd);
        }

        function processCommand(cmd) {
            if (isGameOver && cmd !== 'resetAll') return;
            if (cmd === 'start_30') { stopTimeout(); startTimer(config.key0); }
            else if (cmd === 'start_60') { stopTimeout(); startTimer(config.key2); }
            else if (cmd === 'pause') togglePause();
            else if (cmd === 'resetAll') resetEverything();
            else if (cmd === 'scoreA+') { updateScore('A', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreB+') { updateScore('B', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreA-') updateScore('A', -1);
            else if (cmd === 'scoreB-') updateScore('B', -1);
            else if (cmd === 'extA') { showExt('A'); addTime(config.key0); }
            else if (cmd === 'extB') { showExt('B'); addTime(config.key0); }
            else if (cmd === 'toA') toggleTimeout('A');
            else if (cmd === 'toB') toggleTimeout('B');
            else if (cmd.startsWith('config:')) { config = JSON.parse(cmd.split('config:')[1]); updateRaceToUI(); }
        }

        function startTimer(sec) {
            if (timerId) clearInterval(timerId);
            timeLeft = Number(sec); isPaused = false; updateDisplay();
            document.getElementById('status-text').innerText = isTimeoutMode ? "TIME OUT" : "計時中";
            timerId = setInterval(() => {
                if (!isPaused) {
                    timeLeft--; updateDisplay();
                    if (timeLeft === 10) playBeep(880, 0.1);
                    else if (timeLeft <= 5 && timeLeft > 0) speak(timeLeft);
                    if (timeLeft <= 0) { 
                        clearInterval(timerId); timerId = null; 
                        playBeep(440, 0.8); document.getElementById('status-text').innerText = "TIME UP"; 
                    }
                }
            }, 1000);
        }

        function updateDisplay() {
            const d = document.getElementById('timer-display');
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            d.innerText = isTimeoutMode ? `${m}:${s < 10 ? '0'+s : s}` : (timeLeft < 10 ? "0"+timeLeft : timeLeft);
            d.className = (timeLeft <= 5 && timeLeft > 0 && !isPaused ? "warning" : "");
        }

        function updateScore(t, v) { scores[t] = Math.max(0, scores[t] + v); document.getElementById(`score${t}`).innerText = scores[t]; }
        function showExt(t) { document.getElementById('ext'+t).style.display='block'; }
        function clearExt() { document.getElementById('extA').style.display='none'; document.getElementById('extB').style.display='none'; }
        function addTime(s) { timeLeft += s; updateDisplay(); if (!timerId) startTimer(timeLeft); }
        function togglePause() { if (timerId || timeLeft > 0) { isPaused = !isPaused; document.getElementById('status-text').innerText = isPaused ? "已暫停" : "計時中"; } }
        
        function toggleTimeout(t) { 
            if (isTimeoutMode) { stopTimeout(); return; }
            lastNormalTime = timeLeft; isTimeoutMode = true;
            document.getElementById('to'+t).style.display = 'block';
            startTimer(300);
        }
        function stopTimeout() { if (!isTimeoutMode) return; isTimeoutMode = false; startTimer(lastNormalTime); }

        function checkWinner() {
            if (config.raceTo > 0 && (scores.A >= config.raceTo || scores.B >= config.raceTo)) {
                isGameOver = true; if (timerId) clearInterval(timerId);
                document.getElementById('timer-display').innerText = "WINNER";
                document.getElementById('timer-display').classList.add('winner-text');
                document.body.style.background = scores.A >= config.raceTo ? "var(--red)" : "var(--blue)";
            }
        }

        function resetEverything() {
            if (timerId) clearInterval(timerId);
            timerId = null; scores = {A:0, B:0}; isGameOver = false; isTimeoutMode = false; timeLeft = 0;
            updateScore('A', 0); updateScore('B', 0);
            document.getElementById('toA').style.display='none'; document.getElementById('toB').style.display='none';
            clearExt(); document.body.style.background = "#000"; updateDisplay(); updateRaceToUI();
            document.getElementById('status-text').innerText = "READY";
        }

        function updateRaceToUI() { document.getElementById('race-to-text').innerText = config.raceTo > 0 ? `RACE TO ${config.raceTo}` : "RACE TO --"; }
        function setupTimes() {
            const s = prompt("Start 秒數：", config.key0); if(s !== null) config.key0 = Number(s) || 30;
            const r = prompt("搶幾局 (Race To)：", config.raceTo); if(r !== null) config.raceTo = Number(r) || 0;
            handleInput("config:" + JSON.stringify(config));
        }
        function toggleDisplayMode() { 
            document.body.classList.toggle('hidden-mode');
            document.getElementById('mode-btn').innerText = document.body.classList.contains('hidden-mode') ? "顯示控制" : "切換顯示";
        }

        window.onload = initSignaling;
    </script>
</body>
</html>
